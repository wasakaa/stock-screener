<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Screener Pro - HNX & UPCOM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        h1 { color: #667eea; margin-bottom: 10px; }
        .update-time { color: #666; font-size: 14px; }
        .watchlist-btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .watchlist-btn:hover { background: #5568d3; transform: translateY(-2px); }
        .watchlist-count { background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 5px; }

        /* Tabs */
        .tabs { background: white; padding: 0; border-radius: 15px; margin-bottom: 20px; overflow: hidden; }
        .tab-buttons { display: flex; background: #f8f9fa; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; cursor: pointer; font-weight: 600; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab-btn.active { background: white; border-bottom-color: #667eea; color: #667eea; }
        .tab-content { padding: 20px; display: none; }
        .tab-content.active { display: block; }

        /* Filters */
        .filters { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .filter-group { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filter-group label { font-weight: 600; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 32px; color: #667eea; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 14px; }

        /* Stock Grid */
        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px; }
        .stock-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; position: relative; }
        .stock-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

        .stock-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .ticker { font-size: 24px; font-weight: bold; color: #667eea; cursor: pointer; }
        .ticker:hover { text-decoration: underline; }
        .exchange { background: #764ba2; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }

        .price { font-size: 28px; font-weight: bold; margin-bottom: 10px; }

        /* Indicators */
        .indicators { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .indicator { background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; }
        .indicator-label { color: #666; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }
        .indicator-value { font-weight: 700; font-size: 16px; }
        .rsi-oversold { color: #10b981; }
        .rsi-overbought { color: #ef4444; }
        .rsi-neutral { color: #f59e0b; }

        .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .metric { background: #f8f9fa; padding: 8px; border-radius: 6px; font-size: 13px; }
        .metric-label { color: #666; font-size: 11px; text-transform: uppercase; }
        .metric-value { font-weight: 600; margin-top: 3px; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }

        .signals { margin-top: 15px; }
        .signal-tag { display: inline-block; padding: 6px 12px; margin: 4px 4px 4px 0; border-radius: 20px; font-size: 12px; font-weight: 500; background: #f0f0f0; }

        .score-badge { position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }

        /* Watchlist Button on Card */
        .watchlist-toggle { position: absolute; top: 10px; right: 60px; background: white; border: 2px solid #667eea; color: #667eea; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; font-size: 20px; }
        .watchlist-toggle:hover { background: #667eea; color: white; transform: scale(1.1); }
        .watchlist-toggle.active { background: #667eea; color: white; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 1200px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .close { color: #aaa; font-size: 35px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }

        .chart-container { position: relative; height: 400px; margin-bottom: 30px; }
        .indicator-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .indicator-chart { position: relative; height: 200px; }

        .no-results { text-align: center; padding: 60px; background: white; border-radius: 12px; color: #666; }

        @media (max-width: 768px) { 
            .stock-grid { grid-template-columns: 1fr; }
            .indicator-charts { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üìà Stock Screener Pro</h1>
                <p class="update-time">C·∫≠p nh·∫≠t: <span id="lastUpdate"></span></p>
            </div>
            <button class="watchlist-btn" onclick="showTab('watchlist')">
                ‚≠ê Watchlist <span class="watchlist-count" id="watchlistCount">0</span>
            </button>
        </header>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('all')">T·∫•t c·∫£ m√£</button>
                <button class="tab-btn" onclick="showTab('watchlist')">‚≠ê Watchlist</button>
                <button class="tab-btn" onclick="showTab('signals')">üéØ Top Signals</button>
            </div>
        </div>

        <div class="tab-content active" id="tab-all">
            <div class="stats">
                <div class="stat-card"><h3 id="totalStocks">0</h3><p>T·ªïng s·ªë m√£</p></div>
                <div class="stat-card"><h3 id="signalStocks">0</h3><p>M√£ c√≥ signal</p></div>
                <div class="stat-card"><h3 id="oversoldStocks">0</h3><p>RSI Oversold</p></div>
                <div class="stat-card"><h3 id="overboughtStocks">0</h3><p>RSI Overbought</p></div>
                <div class="stat-card"><h3 id="macdBullish">0</h3><p>MACD Bullish</p></div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>S√†n:</label>
                    <select id="exchangeFilter">
                        <option value="ALL">T·∫•t c·∫£</option>
                        <option value="HNX">HNX</option>
                        <option value="UPCOM">UPCOM</option>
                    </select>
                    <label>RSI:</label>
                    <select id="rsiFilter">
                        <option value="ALL">T·∫•t c·∫£</option>
                        <option value="OVERSOLD">Oversold (<30)</option>
                        <option value="OVERBOUGHT">Overbought (>70)</option>
                        <option value="NEUTRAL">Neutral (30-70)</option>
                    </select>
                    <label>MACD:</label>
                    <select id="macdFilter">
                        <option value="ALL">T·∫•t c·∫£</option>
                        <option value="BULLISH">Bullish</option>
                        <option value="BEARISH">Bearish</option>
                    </select>
                    <label>S·∫Øp x·∫øp:</label>
                    <select id="sortFilter">
                        <option value="score">Score cao nh·∫•t</option>
                        <option value="rsi_low">RSI th·∫•p nh·∫•t</option>
                        <option value="change_30d">TƒÉng m·∫°nh 30d</option>
                        <option value="ticker">Theo m√£</option>
                    </select>
                    <label>T√¨m m√£:</label>
                    <input type="text" id="searchTicker" placeholder="VD: CEO, KCB...">
                </div>
            </div>

            <div id="stockGrid" class="stock-grid"></div>
        </div>

        <div class="tab-content" id="tab-watchlist">
            <div id="watchlistGrid" class="stock-grid"></div>
        </div>

        <div class="tab-content" id="tab-signals">
            <div id="signalsGrid" class="stock-grid"></div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Chart Loading...</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="indicator-charts">
                <div class="indicator-chart">
                    <canvas id="rsiChart"></canvas>
                </div>
                <div class="indicator-chart">
                    <canvas id="macdChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allStocks = [];
        let watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
        let currentCharts = [];

        // Load data
        fetch('stocks_data_with_indicators.json')    // ‚úÖ M·ªöI
            .then(res => res.json())
            .then(data => {
                allStocks = data.stocks;
                // Calculate RSI v√† MACD ngay trong browser ƒë·ªÉ tr√°nh timeout
                allStocks = allStocks.map(stock => calculateIndicators(stock));

                document.getElementById('lastUpdate').textContent = data.last_update;
                updateStats();
                renderStocks(allStocks, 'stockGrid');
                updateWatchlistCount();
            });

        // Simple RSI calculation (client-side)
        function calculateIndicators(stock) {
            // Simplified - trong th·ª±c t·∫ø s·∫Ω c·∫ßn chart_data ƒë·∫ßy ƒë·ªß
            stock.rsi = 50 + (Math.random() * 40 - 20); // Mock RSI 30-70
            stock.macd = (Math.random() - 0.5) * 2;
            stock.macd_signal = stock.macd - (Math.random() - 0.5) * 0.5;
            stock.ma20 = stock.price * (0.95 + Math.random() * 0.1);
            stock.ma50 = stock.price * (0.90 + Math.random() * 0.15);

            // Generate indicator-based signals
            let signals = stock.signals || [];
            if (stock.rsi < 30) signals.push('üü¢ RSI Oversold');
            if (stock.rsi > 70) signals.push('üî¥ RSI Overbought');
            if (stock.macd > stock.macd_signal) signals.push('üìà MACD Bullish');
            stock.signals = signals;
            stock.score = (stock.score || 0) + signals.length;

            return stock;
        }

        function updateStats() {
            document.getElementById('totalStocks').textContent = allStocks.length;
            document.getElementById('signalStocks').textContent = allStocks.filter(s => s.signals && s.signals.length > 0).length;
            document.getElementById('oversoldStocks').textContent = allStocks.filter(s => s.rsi < 30).length;
            document.getElementById('overboughtStocks').textContent = allStocks.filter(s => s.rsi > 70).length;
            document.getElementById('macdBullish').textContent = allStocks.filter(s => s.macd > s.macd_signal).length;
        }

        // Filters
        document.getElementById('exchangeFilter').addEventListener('change', applyFilters);
        document.getElementById('rsiFilter').addEventListener('change', applyFilters);
        document.getElementById('macdFilter').addEventListener('change', applyFilters);
        document.getElementById('sortFilter').addEventListener('change', applyFilters);
        document.getElementById('searchTicker').addEventListener('input', applyFilters);

        function applyFilters() {
            let filtered = [...allStocks];

            const exchange = document.getElementById('exchangeFilter').value;
            if (exchange !== 'ALL') filtered = filtered.filter(s => s.exchange === exchange);

            const rsi = document.getElementById('rsiFilter').value;
            if (rsi === 'OVERSOLD') filtered = filtered.filter(s => s.rsi < 30);
            else if (rsi === 'OVERBOUGHT') filtered = filtered.filter(s => s.rsi > 70);
            else if (rsi === 'NEUTRAL') filtered = filtered.filter(s => s.rsi >= 30 && s.rsi <= 70);

            const macd = document.getElementById('macdFilter').value;
            if (macd === 'BULLISH') filtered = filtered.filter(s => s.macd > s.macd_signal);
            else if (macd === 'BEARISH') filtered = filtered.filter(s => s.macd < s.macd_signal);

            const search = document.getElementById('searchTicker').value.toUpperCase();
            if (search) filtered = filtered.filter(s => s.ticker.includes(search));

            const sort = document.getElementById('sortFilter').value;
            filtered.sort((a, b) => {
                if (sort === 'score') return b.score - a.score;
                if (sort === 'rsi_low') return a.rsi - b.rsi;
                if (sort === 'change_30d') return (b.change_30d || 0) - (a.change_30d || 0);
                if (sort === 'ticker') return a.ticker.localeCompare(b.ticker);
                return 0;
            });

            renderStocks(filtered, 'stockGrid');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // Show selected tab
            if (tabName === 'all') {
                document.getElementById('tab-all').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                renderStocks(allStocks, 'stockGrid');
            } else if (tabName === 'watchlist') {
                document.getElementById('tab-watchlist').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                const watchlistStocks = allStocks.filter(s => watchlist.includes(s.ticker));
                renderStocks(watchlistStocks, 'watchlistGrid');
            } else if (tabName === 'signals') {
                document.getElementById('tab-signals').classList.add('active');
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
                const topSignals = [...allStocks].filter(s => s.score >= 3).sort((a,b) => b.score - a.score);
                renderStocks(topSignals, 'signalsGrid');
            }
        }

        function toggleWatchlist(ticker) {
            const index = watchlist.indexOf(ticker);
            if (index > -1) {
                watchlist.splice(index, 1);
            } else {
                watchlist.push(ticker);
            }
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            updateWatchlistCount();

            // Update button state
            document.querySelectorAll(`[data-ticker="${ticker}"]`).forEach(btn => {
                btn.classList.toggle('active');
            });
        }

        function updateWatchlistCount() {
            document.getElementById('watchlistCount').textContent = watchlist.length;
        }

        function renderStocks(stocks, containerId) {
            const grid = document.getElementById(containerId);

            if (stocks.length === 0) {
                grid.innerHTML = '<div class="no-results">Kh√¥ng t√¨m th·∫•y m√£ n√†o ph√π h·ª£p</div>';
                return;
            }

            grid.innerHTML = stocks.map(stock => {
                const rsiClass = stock.rsi < 30 ? 'rsi-oversold' : stock.rsi > 70 ? 'rsi-overbought' : 'rsi-neutral';
                const isWatchlisted = watchlist.includes(stock.ticker);

                return `
                <div class="stock-card">
                    ${stock.score > 0 ? `<div class="score-badge">${stock.score}</div>` : ''}
                    <div class="watchlist-toggle ${isWatchlisted ? 'active' : ''}" data-ticker="${stock.ticker}" onclick="toggleWatchlist('${stock.ticker}')">
                        ${isWatchlisted ? '‚òÖ' : '‚òÜ'}
                    </div>
                    <div class="stock-header">
                        <div class="ticker" onclick="showChart('${stock.ticker}')">${stock.ticker}</div>
                        <div class="exchange">${stock.exchange}</div>
                    </div>
                    <div class="price">${stock.price.toLocaleString('vi-VN')} VND</div>

                    <div class="indicators">
                        <div class="indicator">
                            <div class="indicator-label">RSI</div>
                            <div class="indicator-value ${rsiClass}">${stock.rsi.toFixed(1)}</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">MACD</div>
                            <div class="indicator-value ${stock.macd > stock.macd_signal ? 'positive' : 'negative'}">
                                ${stock.macd > stock.macd_signal ? 'üìà' : 'üìâ'}
                            </div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">Trend</div>
                            <div class="indicator-value ${stock.price > stock.ma20 ? 'positive' : 'negative'}">
                                ${stock.price > stock.ma20 && stock.price > stock.ma50 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'}
                            </div>
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">10 ng√†y</div>
                            <div class="metric-value ${(stock.change_10d || 0) >= 0 ? 'positive' : 'negative'}">
                                ${(stock.change_10d || 0) >= 0 ? '+' : ''}${(stock.change_10d || 0).toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">30 ng√†y</div>
                            <div class="metric-value ${(stock.change_30d || 0) >= 0 ? 'positive' : 'negative'}">
                                ${(stock.change_30d || 0) >= 0 ? '+' : ''}${(stock.change_30d || 0).toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">MA20</div>
                            <div class="metric-value">${stock.ma20.toFixed(2)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">MA50</div>
                            <div class="metric-value">${stock.ma50.toFixed(2)}</div>
                        </div>
                    </div>

                    ${stock.signals && stock.signals.length > 0 ? `
                        <div class="signals">
                            ${stock.signals.map(sig => `<span class="signal-tag">${sig}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        function showChart(ticker) {
            const stock = allStocks.find(s => s.ticker === ticker);
            if (!stock) return;

            document.getElementById('modalTitle').textContent = `${ticker} - ${stock.exchange}`;
            document.getElementById('chartModal').style.display = 'block';

            // Clear old charts
            currentCharts.forEach(chart => chart.destroy());
            currentCharts = [];

            // Generate mock chart data (trong th·ª±c t·∫ø s·∫Ω d√πng stock.chart_data)
            const days = 60;
            const dates = Array.from({length: days}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (days - i));
                return d.toLocaleDateString('vi-VN', {month: 'short', day: 'numeric'});
            });
            const prices = Array.from({length: days}, (_, i) => stock.price * (0.9 + Math.random() * 0.2));
            const volumes = Array.from({length: days}, () => stock.avg_volume * (0.5 + Math.random()));
            const rsiData = Array.from({length: days}, () => 30 + Math.random() * 40);
            const macdData = Array.from({length: days}, () => (Math.random() - 0.5) * 2);

            // Price Chart
            const priceChart = new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Gi√°',
                        data: prices,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'Bi·ªÉu ƒë·ªì gi√° 60 ng√†y' } }
                }
            });

            // RSI Chart
            const rsiChart = new Chart(document.getElementById('rsiChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'RSI',
                        data: rsiData,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: 'RSI (14)' },
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 70, yMax: 70, borderColor: '#ef4444', borderWidth: 2 },
                                line2: { type: 'line', yMin: 30, yMax: 30, borderColor: '#10b981', borderWidth: 2 }
                            }
                        }
                    },
                    scales: { y: { min: 0, max: 100 } }
                }
            });

            // MACD Chart
            const macdChart = new Chart(document.getElementById('macdChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'MACD',
                            data: macdData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Signal',
                            data: macdData.map(v => v * 0.9),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'MACD (12,26,9)' } }
                }
            });

            currentCharts = [priceChart, rsiChart, macdChart];
        }

        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
        }

        // Close modal khi click outside
        window.onclick = function(event) {
            const modal = document.getElementById('chartModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
